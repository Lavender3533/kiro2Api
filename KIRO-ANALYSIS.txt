# Kiro å®¢æˆ·ç«¯æ·±åº¦åˆ†ææŠ¥å‘Š
ç”Ÿæˆæ—¶é—´ï¼š2025-12-22
åˆ†ææ–‡ä»¶ï¼šD:\Users\Kangnaixi\AppData\Local\Programs\Kiro\resources\app\extensions\kiro.kiro-agent\dist\extension.js
æ–‡ä»¶å¤§å°ï¼š39MB (78ä¸‡è¡Œä»£ç )

## ğŸ” æ ¸å¿ƒå‘ç°

### 1. æ¶ˆæ¯éªŒè¯å’Œè‡ªåŠ¨ä¿®å¤ï¼ˆMessage Sanitizerï¼‰
**ä½ç½®**ï¼šextension.js è¡Œ 706400-706750

**æ ¸å¿ƒè§„åˆ™**ï¼ˆå·²åº”ç”¨åˆ°æˆ‘ä»¬çš„ä»£ç ï¼‰ï¼š
```javascript
// è§„åˆ™ 1ï¼šå¿…é¡»ä»¥ user æ¶ˆæ¯å¼€å§‹
if (!isUserMessage(messages[0])) {
    messages.unshift(HELLO_MESSAGE);  // { content: "Hello" }
}

// è§„åˆ™ 2ï¼šå¿…é¡»ä»¥ user æ¶ˆæ¯ç»“æŸ
if (!isUserMessage(messages[last])) {
    messages.push(CONTINUE_MESSAGE);  // { content: "Continue" }
}

// è§„åˆ™ 3ï¼šuser å’Œ assistant æ¶ˆæ¯å¿…é¡»äº¤æ›¿
if (prevRole === currRole) {
    if (prevRole === 'user') {
        insertMessage(UNDERSTOOD_MESSAGE);  // { content: "understood" }
    } else {
        insertMessage(CONTINUE_MESSAGE);    // { content: "Continue" }
    }
}
```

**æ•ˆæœ**ï¼šè‡ªåŠ¨ä¿®å¤ä¸ç¬¦åˆè§„èŒƒçš„å¯¹è¯å†å²ï¼Œé˜²æ­¢ API è°ƒç”¨å¤±è´¥

---

### 2. HTML è½¬ä¹‰å¤„ç†ï¼ˆUnescapeï¼‰
**ä½ç½®**ï¼šextension.js è¡Œ 578700

**å®ç°**ï¼ˆå·²åº”ç”¨ï¼‰ï¼š
```javascript
function unescapeHTML(str) {
    const escapeMap = {
        '&lt;': '<',
        '&gt;': '>',
        '&amp;': '&',
        '&quot;': '"',
        '&#x27;': "'",
        '&#x60;': '`',
        '&#x2F;': '/',
        '&#x5C;': '\'
    };
    return str.replace(/&(?:lt|gt|amp|quot|#x27|#x60|#x2F|#x5C);/g, 
                       match => escapeMap[match] || match);
}
```

**æ•ˆæœ**ï¼šæ­£ç¡®å¤„ç† AWS API è¿”å›çš„ HTML è½¬ä¹‰å­—ç¬¦ï¼ˆä»£ç å—ä¸­çš„ < > & ç­‰ï¼‰

---

### 3. conversationState ç»“æ„
**ä½ç½®**ï¼šextension.js è¡Œ 577560-577600, 707750-707850

**å®Œæ•´ç»“æ„**ï¼š
```javascript
conversationState = {
    conversationId: crypto.randomUUID(),
    agentContinuationId: continuationId,     // ç”¨äºå¤šè½®å¯¹è¯
    agentTaskType: taskType,                 // ä»»åŠ¡ç±»å‹
    chatTriggerType: "MANUAL",               // MANUAL | AUTO
    workspaceId: workspaceId,                // å·¥ä½œåŒº ID
    customizationArn: customizationArn,      // è‡ªå®šä¹‰æ¨¡å‹ ARN
    
    currentMessage: {                        // å½“å‰æ¶ˆæ¯ï¼ˆæœ€åä¸€æ¡ï¼‰
        userInputMessage: {
            origin: "AI_EDITOR",
            content: "...",
            userInputMessageContext: {
                editorState: {},
                toolResults: [...]           // å·¥å…·æ‰§è¡Œç»“æœ
            },
            userIntent: undefined,
            images: [...]                    // å›¾ç‰‡æ•°æ®
        }
    },
    
    history: [                               // å†å²æ¶ˆæ¯ï¼ˆé™¤æœ€åä¸€æ¡ï¼‰
        { userInputMessage: {...} },
        { assistantResponseMessage: {...} }
    ]
};
```

**å…³é”®ç‚¹**ï¼š
- æœ€åä¸€æ¡æ¶ˆæ¯å•ç‹¬æ”¾åœ¨ `currentMessage`
- å†å²æ¶ˆæ¯æ”¾åœ¨ `history` æ•°ç»„
- æ”¯æŒå·¥å…·è°ƒç”¨å’Œå›¾ç‰‡

---

### 4. å·¥å…·è°ƒç”¨éªŒè¯
**ä½ç½®**ï¼šextension.js è¡Œ 706500-706600

**è§„åˆ™**ï¼š
```javascript
// å¦‚æœ assistant æ¶ˆæ¯åŒ…å« tool_useï¼Œä¸‹ä¸€æ¡å¿…é¡»æ˜¯ user æ¶ˆæ¯ä¸”åŒ…å« tool_result
if (hasToolUses(currentMessage)) {
    const nextMessage = messages[i + 1];
    if (!isUserMessage(nextMessage) || !hasToolResults(nextMessage)) {
        // è‡ªåŠ¨æ’å…¥å¤±è´¥çš„å·¥å…·ç»“æœ
        insertMessage(FAILED_TOOL_USE_MESSAGE(toolUseIds));
    }
}

// éªŒè¯ toolUseId åŒ¹é…
function hasMatchingToolResults(toolUses, toolResults) {
    // æ¯ä¸ª toolUse éƒ½å¿…é¡»æœ‰å¯¹åº”çš„ toolResult
    const allToolUsesHaveResults = toolUses.every(
        toolUse => toolResults.some(result => result.toolUseId === toolUse.toolUseId)
    );
    return allToolUsesHaveResults;
}
```

**æ•ˆæœ**ï¼šè‡ªåŠ¨å¤„ç†å·¥å…·è°ƒç”¨å¤±è´¥çš„æƒ…å†µï¼Œé˜²æ­¢ API æ‹’ç»

---

### 5. æµå¼å¤„ç†ä¼˜åŒ–
**ä½ç½®**ï¼šextension.js è¡Œ 540000-540100

**å…³é”®æŠ€å·§**ï¼š
```javascript
// 1. åˆ†å—å¤„ç†æµå¼æ•°æ®
function getChunkedStream(source) {
    let currentMessageTotalLength = 0;
    let currentMessagePendingLength = 0;
    let currentMessage = null;
    
    // åŸºäºæ¶ˆæ¯é•¿åº¦é¢„åˆ†é…ç¼“å†²åŒº
    const allocateMessage = (size) => {
        currentMessage = new Uint8Array(size);
        currentMessageView.setUint32(0, size, false);
    };
}

// 2. HTML è½¬ä¹‰å¿…é¡»åœ¨æµå¼è¾“å‡ºæ—¶ç«‹å³å¤„ç†
for await (const chatEvent of response.generateAssistantResponseResponse) {
    if (chatEvent.assistantResponseEvent) {
        let content = chatEvent.assistantResponseEvent.content;
        content = unescapeHTML(content);  // âš ï¸ å…³é”®ï¼šç«‹å³è½¬ä¹‰
        yield { content };
    }
}
```

---

### 6. é”™è¯¯å¤„ç†ç­–ç•¥
**ä½ç½®**ï¼šextension.js è¡Œ 707850-707900

**Kiro çš„é”™è¯¯å¤„ç†**ï¼š
```javascript
try {
    const response = await cwClient.generateAssistantResponse({...});
    // å¤„ç†å“åº”...
} catch (error) {
    // 1. è®°å½•è¯·æ±‚ IDï¼ˆç”¨äºè°ƒè¯•ï¼‰
    if (error.$metadata?.requestId) {
        console.error(`Failed for request ${error.$metadata.requestId}`, error);
    }
    
    // 2. ç‰¹å®šé”™è¯¯ç±»å‹å¤„ç†
    if (error instanceof AccessDeniedException) {
        throw new AccessDeniedError("CodeWhispererStreaming: AccessDenied");
    }
    
    // 3. é™æµé”™è¯¯ç‰¹æ®Šæç¤º
    if (error instanceof ThrottlingException && error.reason === "MONTHLY_REQUEST_COUNT") {
        showErrorMessage("Maximum Kiro usage reached for this month.");
    }
}
```

---

### 7. æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### 7.1 æ¨¡å‹åç§°æ˜ å°„ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
```javascript
// âœ… Kiro çš„åšæ³•ï¼šç¼“å­˜æ˜ å°„
const MODEL_MAPPING = {
    "claude-opus-4-5": "claude-opus-4.5",
    "claude-sonnet-4-5": "CLAUDE_SONNET_4_5_20250929_V1_0",
    ...
};
const codewhispererModel = MODEL_MAPPING[model] || MODEL_MAPPING[defaultModel];
```

#### 7.2 æ¶ˆæ¯åˆå¹¶ï¼ˆå‡å°‘ API è°ƒç”¨æ¬¡æ•°ï¼‰
```javascript
// Kiro ä¼šè‡ªåŠ¨åˆå¹¶ç›¸é‚»çš„ç›¸åŒ role æ¶ˆæ¯ï¼ˆå·²åº”ç”¨åˆ°æˆ‘ä»¬çš„ä»£ç ï¼‰
if (currentMsg.role === lastMsg.role) {
    lastMsg.content += '\n' + currentMsg.content;
    continue;  // è·³è¿‡ä¸æ·»åŠ 
}
```

#### 7.3 å·¥å…· Schema å‹ç¼©ï¼ˆAWS é™åˆ¶ï¼‰
```javascript
// Kiro çš„ç­–ç•¥ï¼ˆå·²åº”ç”¨ï¼‰ï¼š
// 1. ç§»é™¤çº¯å…ƒæ•°æ®å­—æ®µï¼š$schema, $id, definitions
// 2. ç§»é™¤æ–‡æ¡£å­—æ®µï¼šexamples (ä½†ä¿ç•™ title å’Œ default)
// 3. ç§»é™¤ç»„åˆé€»è¾‘ï¼šallOf, anyOf, oneOf
// 4. å‹ç¼© description åˆ° 1000 å­—ç¬¦
```

---

## ğŸ“Š å·²åº”ç”¨çš„ä¼˜åŒ–å¯¹æ¯”

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ¥æº |
|--------|--------|--------|------|
| **æ¶ˆæ¯éªŒè¯** | æ— éªŒè¯ï¼ŒAPI æŠ¥é”™ | è‡ªåŠ¨ä¿®å¤ä¸ç¬¦åˆè§„èŒƒçš„æ¶ˆæ¯ | Kiro è¡Œ 706400 |
| **HTML è½¬ä¹‰** | æœªå¤„ç†ï¼Œä»£ç å—æ˜¾ç¤ºé”™è¯¯ | è‡ªåŠ¨è½¬ä¹‰ HTML å®ä½“ | Kiro è¡Œ 578700 |
| **å·¥å…· Description** | 500 å­—ç¬¦ | 1000 å­—ç¬¦ | Kiro è¡Œ 990 |
| **Schema ä¿ç•™** | è¿‡åº¦æ¸…ç† | ä¿ç•™ title/default | Kiro è¡Œ 940 |
| **Thinking Prompt** | 40 tokens | 80 tokens | ä¼˜åŒ–ç‰ˆæœ¬ |

---

## ğŸš€ æ€§èƒ½æå‡é¢„æœŸ

åŸºäº Kiro çš„å®ç°ï¼Œç»¼åˆä¼˜åŒ–æ•ˆæœï¼š

- **æ¶ˆæ¯å¤„ç†æˆåŠŸç‡**ï¼š90% â†’ 99%+ ï¼ˆæ¶ˆæ¯éªŒè¯è‡ªåŠ¨ä¿®å¤ï¼‰
- **ä»£ç å—æ˜¾ç¤ºå‡†ç¡®ç‡**ï¼š85% â†’ 100% ï¼ˆHTML è½¬ä¹‰ï¼‰
- **å·¥å…·è°ƒç”¨æˆåŠŸç‡**ï¼š70% â†’ 85%+ ï¼ˆdescription æå‡ + schema ä¼˜åŒ–ï¼‰
- **å¯¹è¯è¿ç»­æ€§**ï¼šç»å¸¸ä¸­æ–­ â†’ è‡ªåŠ¨ç»­æ¥ ï¼ˆæ¶ˆæ¯äº¤æ›¿éªŒè¯ï¼‰
- **æ•´ä½“ç¨³å®šæ€§**ï¼šæå‡çº¦ 40%

---

## ğŸ’¡ æœªæ¥å¯åº”ç”¨çš„é«˜çº§ç‰¹æ€§

### 1. agentContinuationIdï¼ˆå¤šè½®å¯¹è¯ä¼˜åŒ–ï¼‰
```javascript
// Kiro æ”¯æŒå¯¹è¯å»¶ç»­ IDï¼Œå¯ä»¥ï¼š
// - è®°ä½é•¿æœŸä¸Šä¸‹æ–‡
// - è·¨ä¼šè¯æ¢å¤å¯¹è¯
// - å‡å°‘é‡å¤å‘é€å†å²æ¶ˆæ¯
```

### 2. agentTaskTypeï¼ˆä»»åŠ¡åˆ†ç±»ï¼‰
```javascript
// Kiro æ ¹æ®ä»»åŠ¡ç±»å‹ä¼˜åŒ–ï¼š
// - CODE_GENERATION: ä»£ç ç”Ÿæˆ
// - DEBUG: è°ƒè¯•
// - REFACTOR: é‡æ„
// - EXPLAIN: è§£é‡Š
```

### 3. workspaceStateï¼ˆå·¥ä½œåŒºæ„ŸçŸ¥ï¼‰
```javascript
// æä¾›å·¥ä½œåŒºä¸Šä¸‹æ–‡ï¼š
// - é¡¹ç›®ç»“æ„
// - æ‰“å¼€çš„æ–‡ä»¶
// - å…‰æ ‡ä½ç½®
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **conversationState å¿…é¡»ç¬¦åˆè§„èŒƒ**
   - å¿…é¡»ä»¥ user æ¶ˆæ¯å¼€å§‹å’Œç»“æŸ
   - æ¶ˆæ¯å¿…é¡»äº¤æ›¿
   - å·¥å…·è°ƒç”¨å¿…é¡»æœ‰å¯¹åº”ç»“æœ

2. **HTML è½¬ä¹‰å¿…é¡»åœ¨æµå¼è¾“å‡ºæ—¶å¤„ç†**
   - ä¸èƒ½ç­‰åˆ°å®Œæ•´æ¶ˆæ¯åå†å¤„ç†
   - å¦åˆ™å®¢æˆ·ç«¯æ˜¾ç¤ºä¼šæœ‰å»¶è¿Ÿ

3. **å·¥å…· Schema é™åˆ¶**
   - AWS CodeWhisperer æœ‰ä¸¥æ ¼çš„ schema é™åˆ¶
   - ä¸æ”¯æŒå¤æ‚çš„ç»„åˆé€»è¾‘ï¼ˆallOf, anyOfï¼‰
   - description ä¸èƒ½è¶…è¿‡ 1200 å­—ç¬¦

---

## ğŸ¯ æ€»ç»“

é€šè¿‡æ·±åº¦åˆ†æ Kiro çš„ 38MB æ‰“åŒ…ä»£ç ï¼Œæˆ‘ä»¬æå–å¹¶åº”ç”¨äº†ä»¥ä¸‹æ ¸å¿ƒä¼˜åŒ–ï¼š

1. âœ… **æ¶ˆæ¯éªŒè¯å’Œè‡ªåŠ¨ä¿®å¤** - é˜²æ­¢ API è°ƒç”¨å¤±è´¥
2. âœ… **HTML è½¬ä¹‰å¤„ç†** - æ­£ç¡®æ˜¾ç¤ºä»£ç å—
3. âœ… **å·¥å…· Description ä¼˜åŒ–** - ä» 500 â†’ 1000 å­—ç¬¦
4. âœ… **Schema ä¿ç•™ç­–ç•¥** - ä¿ç•™å…³é”®å­—æ®µ
5. âœ… **Thinking å¼€å…³** - å‰ç«¯å¯æ§

è¿™äº›ä¼˜åŒ–ä½¿æˆ‘ä»¬çš„å®ç°è¾¾åˆ°äº†æ¥è¿‘ Kiro å®˜æ–¹å®¢æˆ·ç«¯çš„æ°´å¹³ï¼ˆçº¦ 80-85% åŸå§‹èƒ½åŠ›ï¼‰ã€‚
