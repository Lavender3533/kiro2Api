<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¦å·æ±  API æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-item {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            font-size: 14px;
            color: #999;
            margin-top: 5px;
        }
        .pool {
            background: #333;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .pool.healthy { border-left: 4px solid #4CAF50; }
        .pool.checking { border-left: 4px solid #FFC107; }
        .pool.banned { border-left: 4px solid #F44336; }
        .pool-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .account {
            background: #444;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ è´¦å·æ±  API æµ‹è¯•</h1>

    <div class="card">
        <button onclick="loadPoolData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        <button onclick="loadStatsData()">ğŸ“Š æŸ¥çœ‹ /stats æ¥å£</button>
    </div>

    <div id="stats-container"></div>
    <div id="pools-container"></div>
    <div id="raw-data-container"></div>

    <script>
        async function loadPoolData() {
            try {
                const response = await fetch('/api/providers');
                const data = await response.json();

                console.log('API Response:', data);

                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                if (data._accountPoolStats) {
                    const stats = data._accountPoolStats;
                    document.getElementById('stats-container').innerHTML = `
                        <div class="card">
                            <h2>ğŸ“Š è´¦å·æ± ç»Ÿè®¡</h2>
                            <div class="stats">
                                <div class="stat-item">
                                    <div class="stat-value">${stats.total}</div>
                                    <div class="stat-label">æ€»è´¦æˆ·æ•°</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" style="color: #4CAF50">${stats.healthy}</div>
                                    <div class="stat-label">å¥åº·è´¦æˆ·</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" style="color: #FFC107">${stats.checking}</div>
                                    <div class="stat-label">æ£€æŸ¥æ± </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" style="color: #F44336">${stats.banned}</div>
                                    <div class="stat-label">å¼‚å¸¸æ± </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${stats.totalUsageCount}</div>
                                    <div class="stat-label">æ€»ä½¿ç”¨æ¬¡æ•°</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${stats.totalErrorCount}</div>
                                    <div class="stat-label">æ€»é”™è¯¯æ¬¡æ•°</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${stats.cacheHitRate}</div>
                                    <div class="stat-label">ç¼“å­˜å‘½ä¸­ç‡</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // æ˜¾ç¤ºä¸‰ä¸ªæ± çš„è¯¦ç»†ä¿¡æ¯
                if (data._accountPoolDetails) {
                    const details = data._accountPoolDetails;
                    let poolsHtml = '<div class="card"><h2>ğŸŠ è´¦å·æ± è¯¦æƒ…</h2>';

                    // å¥åº·æ± 
                    poolsHtml += `
                        <div class="pool healthy">
                            <div class="pool-title">ğŸŸ¢ å¥åº·æ±  (${details.healthy.length})</div>
                            ${details.healthy.length === 0 ? '<p>æš‚æ— è´¦å·</p>' :
                              details.healthy.map(acc => `
                                <div class="account">
                                    ID: ${acc.id} |
                                    ä½¿ç”¨: ${acc.usageCount || 0} |
                                    é”™è¯¯: ${acc.errorCount || 0}
                                </div>
                              `).join('')}
                        </div>
                    `;

                    // æ£€æŸ¥æ± 
                    poolsHtml += `
                        <div class="pool checking">
                            <div class="pool-title">ğŸŸ¡ æ£€æŸ¥æ±  (${details.checking.length})</div>
                            ${details.checking.length === 0 ? '<p>æš‚æ— è´¦å·</p>' :
                              details.checking.map(acc => `
                                <div class="account">
                                    ID: ${acc.id} |
                                    é”™è¯¯: ${acc.lastError?.message || 'Unknown'}
                                </div>
                              `).join('')}
                        </div>
                    `;

                    // å¼‚å¸¸æ± 
                    poolsHtml += `
                        <div class="pool banned">
                            <div class="pool-title">ğŸ”´ å¼‚å¸¸æ±  (${details.banned.length})</div>
                            ${details.banned.length === 0 ? '<p>æš‚æ— è´¦å·</p>' :
                              details.banned.map(acc => `
                                <div class="account">
                                    ID: ${acc.id} |
                                    åŸå› : ${acc.lastError?.message || 'Unknown'}
                                </div>
                              `).join('')}
                        </div>
                    `;

                    poolsHtml += '</div>';
                    document.getElementById('pools-container').innerHTML = poolsHtml;
                }

                // æ˜¾ç¤ºåŸå§‹æ•°æ®
                document.getElementById('raw-data-container').innerHTML = `
                    <div class="card">
                        <h2>ğŸ“„ åŸå§‹ API å“åº”</h2>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

            } catch (error) {
                console.error('Error:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        async function loadStatsData() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();

                document.getElementById('raw-data-container').innerHTML = `
                    <div class="card">
                        <h2>ğŸ“Š /stats æ¥å£å“åº”</h2>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                console.error('Error:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
        loadPoolData();
    </script>
</body>
</html>
